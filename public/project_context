# Poliestetica - Project Context

## ğŸ¥ Panoramica del Progetto

**Azienda:** Poliestetica Pignatelli Srl  
**Settore:** Poliambulatorio medico specializzato in medicina estetica  
**Sede:** Via Battaglia 71/C, 35020 Albignasego (PD)  
**Responsabile:** Elio Pignatelli, Amministratore Unico

### Obiettivo
Sistema di Gestione Compensi Medici automatizzato per:
- Import automatico fatture da Fatture in Cloud via API
- Calcolo automatico compensi con formule personalizzabili per medico
- Gestione anomalie e errori di importazione
- Report e export in Excel/PDF
- Chiusura mensile con controlli e blocco modifiche
- ScalabilitÃ  per futura seconda sede

## ğŸ—ï¸ Architettura Tecnica

### Stack Tecnologico
- **Frontend:** Next.js 14 con App Router
- **Database:** Supabase (PostgreSQL gestito + Auth) - Piano Pro consigliato
- **Deployment:** Vercel
- **Styling:** Tailwind CSS
- **Icone:** Lucide React
- **State Management:** Zustand (previsto)

### Struttura Cartelle
src/
â”œâ”€ app/                     # App Router (route = folder)
â”‚  â”œâ”€ layout.tsx            # shell globale (Header, Navigation, <main>)
â”‚  â”œâ”€ page.tsx              # dashboard (root)
â”‚  â”œâ”€ import/page.tsx       # Import Fatture
â”‚  â”œâ”€ medici/page.tsx       # Gestione Medici
â”‚  â””â”€ compensi/page.tsx     # Calcola Compensi
â”‚
â”œâ”€ components/              # SOLO UI riusabili (Client Components)
â”‚  â”œâ”€ ui/                   # atomi piccoli (Button, Card, Badge, Modal)
â”‚  â”œâ”€ FatturaTable.tsx      # pezzi dei featureâ€‘page che servono altrove
â”‚  â””â”€ MenuCard.tsx
â”‚
â”œâ”€ lib/                     # puro JavaScript/TypeScript (zero React)
â”‚  â”œâ”€ utils.ts              # formatter, parser, ecc.
â”‚  â”œâ”€ hooks.ts              # hook leggeri (useDebounce, useMediaQueryâ€¦)
â”‚  â””â”€ types.ts              # shared types & enums
â”‚
â”œâ”€ services/                # chiamate di rete o wrapper DB
â”‚  â”œâ”€ fatture.ts            # fetchFatture(), syncFatture()
â”‚  â””â”€ medici.ts
â”‚
â””â”€ store.ts                 # piccolo Zustand/Context per stato globale

## ğŸ“¦ Moduli Principali

### 1. Dashboard âœ…
- Menu a 6 card con illustrazioni personalizzate
- Navigazione superiore persistente
- Sistema notifiche
- Selector ruolo (Admin/Segretaria/Responsabile)

### 2. Import Fatture âœ…
- Sincronizzazione da Fatture in Cloud API
- Gestione anomalie (medico mancante, codice sconosciuto, duplicati)
- Import incrementale (solo fatture nuove)
- Serie fatture: Principale, IVA, M (ignora serie E)
- Export Excel/PDF con filtro date
- Import automatico alle 22:00

### 3. Gestione Medici âœ… (v4)
- CRUD medici completo
- Rule builder per compensi:
  - Percentuale su netto/lordo
  - A scaglioni: â‚¬X ogni â‚¬Y imponibile
  - Quota fissa: â‚¬X ogni Y prestazioni
- Import/Export Excel per costi prodotti
- Gestione eccezioni per prestazione/prodotto
- UnitÃ  di misura prodotti (fiala, ml, siringa, ecc.)
- Tab Simulatore compensi (solo admin)

### 4. Calcola Compensi âœ… (v2)
- Sistema chiusura gerarchico: medici â†’ mese generale
- Gestione fatture con/senza IVA:
  - Con IVA: FT/2024/123IVA (22%)
  - Senza IVA: FT/2024/123 (lordo = netto)
- Workflow calcolo compensi
- Modifica manuale con tracciabilitÃ 
- Gestione anomalie prodotti non mappati
- Export Excel/PDF per tipologia fattura

### 5. Da Sviluppare
- **Statistiche:** Dashboard KPI
- **Archivio:** Storico periodi + storico import + report

## ğŸ”‘ Sistema Permessi

| Azione | Admin | Segretaria/Responsabile |
|--------|-------|------------------------|
| Visualizzare dati | âœ… | âœ… |
| Modificare compensi | âœ… | âœ… (solo se medico+mese aperti) |
| Modificare costi prodotti | âœ… | âœ… |
| Modificare anagrafica medici | âœ… | âŒ |
| Chiudere singolo medico | âœ… | âœ… |
| Riaprire singolo medico | âœ… | âœ… (solo se mese aperto) |
| Chiudere mese | âœ… | âœ… |
| Riaprire mese | âœ… | âŒ |
| Download Excel/PDF | âœ… | âœ… (dopo chiusura mese) |

## ğŸ¨ Design System

### Colori Brand
- Primary: `#03A6A6` (turchese)
- Secondary: `#6192A9` (blu)
- Accent: `#8C786C`, `#D9AC9C`, `#E9EDF2`

### UI/UX Guidelines
- Modal React personalizzati (no alert/confirm nativi per compatibilitÃ  iframe)
- Stili inline per colori custom (problemi con Tailwind in artifacts)
- Campi read-only con sfondo grigio per non-admin
- Indicatori visivi stati (lucchetto aperto/chiuso)

## ğŸ”„ Workflow Chiave

### Chiusura Mensile
1. **Chiusura Medici** (reversibile)
   - Verifica fatture aggiornate (API check)
   - Checklist: fatture importate, anomalie risolte, calcoli verificati
   - Blocco automatico se anomalie presenti

2. **Chiusura Mese** (irreversibile)
   - Condizione: TUTTI i medici chiusi
   - Abilita passaggio al mese successivo
   - Consolida dati per reportistica

### Calcolo Compensi
Per ogni voce fattura:

Determina base (lordo o netto secondo regola)
Se lordo = netto (fatture senza IVA) â†’ usa netto
Detrae costo prodotto (se detraiCosto = true)
Applica regola compenso (%, scaglioni, fisso)
Risultato: compenso finale


**âš ï¸ NOTA:** Attualmente usa 50% fisso per demo. In produzione userÃ  regole reali da Gestione Medici.

## ğŸ”Œ Integrazioni

### Fatture in Cloud API
```javascript
// Verifica fatture aggiornate
GET /c/{company_id}/issued_documents
?supplier_id={medicoId}
&modified_after={lastImportDate}
&fields=id,number,modified_at
Supabase (previsto)

Autenticazione utenti
Storage fatture e compensi
Real-time updates
Backup point-in-time (Piano Pro)

ğŸ“ Note Importanti per lo Sviluppo
Da Implementare per Produzione

Integrazione Gestione Medici â†” Calcola Compensi

Leggere regole reali invece di 50% fisso
Sincronizzare costi prodotti
Aggiornare listino quando si mappa nuovo prodotto


Performance

Virtualizzazione liste lunghe (react-window)
Lazy loading dettagli
Ottimizzare useMemo/useCallback


Testing

Workflow chiusura con edge cases
Calcolo compensi con diverse regole
Gestione concorrenza modifiche


Audit Trail

Log completo modifiche
Chi/quando/cosa per compliance



Convenzioni Codice

TypeScript strict mode
React functional components con hooks
Naming: camelCase per variabili, PascalCase per componenti
Commenti in italiano per logica business

Deployment

Branch main â†’ produzione automatica su Vercel
Branch develop â†’ staging
Environment variables in .env.local

ğŸš€ Quick Start
bash# Clone repository
git clone [repo-url]

# Install dependencies
npm install

# Environment setup
cp .env.example .env.local
# Configura Supabase e Fatture in Cloud API keys

# Development
npm run dev

# Build
npm run build

# Test (quando implementati)
npm run test
ğŸ“ Contatti Tecnici
Per domande tecniche sul progetto, contattare il team di sviluppo.

Ultimo aggiornamento: [Data corrente]
Versione: 1.0.0

Questo file `project_context.md` fornisce tutto il contesto necessario per Claude Code o altri sviluppatori che devono lavorare sul progetto. Include:

1. **Panoramica completa** del progetto e obiettivi
2. **Architettura tecnica** dettagliata con struttura cartelle
3. **Descrizione moduli** con stato di implementazione
4. **Sistema permessi** in formato tabellare chiaro
5. **Design system** con colori e guidelines
6. **Workflow chiave** spiegati passo-passo
7. **Integrazioni API** con esempi
8. **Note per produzione** con todo list chiara
9. **Quick start** per iniziare velocemente

Il documento Ã¨ strutturato per essere facilmente navigabile e fornire rapidamente le informazioni necessarie per comprendere e lavorare sul progetto.